<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <title>CCPA Tool</title>
    <style>
        .widget-container {
            position: fixed;
            bottom: 0;
            right: 0;
            width: 300px;
        }

        .widget-button {
            display: inline-block;
            background-color: #01AECD;
            color: #FFFFFF;
            font-family: 'Lato', sans-serif;
            font-size: 16px;
            font-weight: 500;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
            text-align: center;
        }

        .widget-button:disabled {
            cursor: not-allowed;
            opacity: .65;
            box-shadow: none;
        }

        .widget-button:hover, .widget-button:active {
            background-color: #0097b3;
        }

        .widget-button::before {
            content: "";
            width: 16px;
            height: 16px;
            border: 2px solid white;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            position: absolute;
            left: 65px;
            display: none;
        }

        .widget-button.processing::before {
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .widget-button .checkmark {
            content: "✔";
            font-size: 16px;
            color: white;
            margin-right: 10px;
            display: none;
        }

        .widget-button.completed .checkmark {
            display: inline-block;
        }

        .widget-button.completed::before {
            display: none;
        }
    </style>
</head>
<body>
<div class="widget-container">
    <button class="widget-button" id="widget-button" onclick="optOutAll()">Opt out companies</button>
</div>

<script>
  const companiesUrl = "https://s3.amazonaws.com/widget-production.com/companies.json";
  const widgetUrl = "https://d2r0xny6oyiap.cloudfront.net";
  const tokenUrlRegex = /^https?:\/\/[^\/]+\/token\/[^\/]+\/[^\/]+\/([^\/]+)\/?$/;
  const resultUrlRegex = /^(?:https?:\/\/[^\/]+\/finish\/([^\/]+)\/[^\/]+\/([^\/]+))\/?$/;
  const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor) && !/Edg/.test(navigator.userAgent);
  let companies = [];

  function optOutAll() {
    if (!isChrome) {
      toggleWidgetButtonProcessing(false);
      window.top.postMessage({
        type: 'UpdateOptedOutCompanies',
        data: {
          failed: [],
          discard: [],
          successful: [...new Set(companies.flatMap(company => company.trigger.actions.map(trigger => trigger.daaParticipant)))]
        }
      }, '*');
      return;
    }
    const promises = [];
    const batchSize = 10; // Number of requests to send at a time
    const delay = 10; // Delay between batches in milliseconds
    toggleWidgetButtonProcessing(true);

    companies.forEach(company => {
      company.trigger.actions.forEach(actionTrigger => {
        promises.push(() => createIframeChains({
          url: actionTrigger.url,
          actionId: actionTrigger.actionId,
          participantId: actionTrigger.participantId,
          daaParticipant: actionTrigger.daaParticipant}));
      });
    });

    executeInBatches(promises, batchSize, delay);
  }

  function toggleWidgetButtonProcessing(processing = true) {
    const widgetButton = document.getElementById("widget-button");

    if (!widgetButton) {
      return;
    }

    if (processing) {
      widgetButton.innerText = "Processing...";
      widgetButton.classList.add("processing");
      widgetButton.classList.remove("completed");
      widgetButton.disabled = true;
      return;
    }

    widgetButton.innerHTML = '<span class="checkmark">✔</span> Requests are completed';
    widgetButton.classList.remove("processing");
    widgetButton.classList.add("completed");
    widgetButton.disabled = false;

    const timer = setTimeout(() => {
      clearTimeout(timer);
      widgetButton.innerText = "Opt out companies";
    }, 2000);
  }

  function executeInBatches(promises, batchSize, delay) {
    let batchIndex = 0;
    let allResults = [];

    function executeBatch() {
      const batchPromises = promises.slice(batchIndex, batchIndex + batchSize).map(fn => fn());
      return Promise.allSettled(batchPromises)
        .then((results) => {
          allResults = allResults.concat(results);
          batchIndex += batchSize;
          if (batchIndex < promises.length) {
            setTimeout(executeBatch, delay);
          } else {
            toggleWidgetButtonProcessing(false);
            // TODO remove
            const failedDaaParticipants = allResults.filter(result => result.status === 'rejected').map(result => result.reason.daaParticipant);
            const successfulDaaParticipants = allResults.filter(result => result.status === 'fulfilled').map(result => result.value.daaParticipant);
            console.log("Detailed results", allResults);
            console.log(`All actions completed. Number of companies with failures: ${failedDaaParticipants.length}`);
            console.log(`Successful daa participants`, successfulDaaParticipants);
            window.top.postMessage({type: 'UpdateOptedOutCompanies', data: {failed: failedDaaParticipants, successful: successfulDaaParticipants, discard: []}}, '*');
          }
        })
        .catch(error => {
          console.error('Error batch execution:', error);
        });
    }

    executeBatch();
  }

  function getIframeUrl({originUrl, actionId, participantId, token, location}) {
    function getRandomizedValue() {
      return Math.floor(Math.random() * 9e12) + 1e12;
    }

    return `${originUrl}?action_id=${actionId}&participant_id=${participantId}&${token ? `token=${token}&` : ''}rd=${encodeURIComponent(location)}&noCache=${getRandomizedValue()}`;
  }

  function iframeLoad({iframeSrc, widgetUrl}) {
    return new Promise((resolve, reject) => {
      const iframe = document.createElement('iframe');
      iframe.src = iframeSrc;
      iframe.style.display = 'none';
      document.body.appendChild(iframe);
      iframe.onload = () => {
        try {
          const resolvedURL = iframe.contentWindow.location.href;
          const foundOrigin = new URL(resolvedURL).origin;
          if (foundOrigin !== widgetUrl) {
            reject(`Resolved URL origin ${foundOrigin} does not match the allowed origin ${widgetUrl}`);
          }

          resolve(resolvedURL);
        } catch (error) {
          reject(error);
        }
      }
      iframe.onerror = (error) => {
        reject(error);
      };
    });
  }

  function processIframeResult({ iframeLocation, participantId }) {
    const [_, resParticipantId, resStatus] = iframeLocation.match(resultUrlRegex) || [];
    if (!isNaN(Number(resParticipantId)) && participantId !== Number(resParticipantId)) {
      throw new Error(`Participant ids do not match!`);
    }
    if (resStatus && !resStatus.startsWith("1")) {
      throw new Error(`Result is not successful!`);
    }
    return iframeLocation;
  }

  function createIframeChains({ url, actionId, participantId, daaParticipant }) {
    return new Promise((resolve, reject) => {
      if (actionId === 3) {
        iframeLoad({
          iframeSrc: getIframeUrl({ originUrl: url, actionId: 3, participantId, location: window.location.origin }),
          widgetUrl
        })
          .then((resolvedURL) => {
            const [_, token] = resolvedURL.match(tokenUrlRegex) || [];
            return iframeLoad({
              iframeSrc: getIframeUrl({ originUrl: url, actionId: 4, participantId, token, location: window.location.origin }),
              widgetUrl
            });
          })
          .then((iframeLocation) => {
            const url = processIframeResult({ iframeLocation, participantId });
            resolve({ url, participantId, daaParticipant });
          })
          .catch((error) => {
            reject({ error: error.message, participantId, daaParticipant });
          });
      } else if (actionId === 4) {
        iframeLoad({
          iframeSrc: getIframeUrl({ originUrl: url, actionId: 4, participantId, token: null, location: window.location.origin }),
          widgetUrl
        })
          .then((iframeLocation) => {
            const url = processIframeResult({ iframeLocation, participantId });
            resolve({ url, participantId, daaParticipant });
          })
          .catch((error) => {
            reject({ error: error.message, participantId, daaParticipant });
          });
      } else {
        reject({ error: `Unknown actionId=${actionId}`, participantId, daaParticipant });
      }
    });
  }

  function toggleWidgetAvailability(displayWidget) {
    const iframeElement = parent.document.getElementById('pmc-widget');
    iframeElement.style.display = displayWidget ? 'block' : 'none';
  }

  function initializeWidget() {
    if (new URL(document.location.href).href !== new URL(widgetUrl).href) {
      return;
    }
    toggleWidgetAvailability(false);
    fetchCompanies()
      .then(data => {
        if (!data || !data.hasOwnProperty('active') || !data.hasOwnProperty('companies') || !data?.active) {
          return;
        }
        if (data?.active && !data?.companies?.length) {
          return;
        }
        if (data.active) {
          companies = data.companies;
          toggleWidgetAvailability(true);
        }
      });
  }

  function fetchCompanies() {
    return fetch(companiesUrl)
      .then(response => {
        if (!response.ok) {
          return {};
        }
        return response.json();
      })
      .catch(() => {});
  }

  window.onload = initializeWidget;
</script>
</body>
</html>
