<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSS Widget</title>
    <style>
        .widget-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 400px;
        }

        .widget-button {
            display: inline-block;
            background-color: #007bff;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
        }
        .widget-button.olive {
            color: #fff;
            background-color: olive;
        }

        .widget-button.lightgray {
            color: black;
            background-color: lightgray;
        }
        .widget-button.lightgrey {
            color: black;
            background-color: lightgrey;
        }
        .widget-button.fail {
            border: 2px solid red;
        }
        .widget-button.success, .widget-button.successWhenNoAdBlocker {
            border: 2px solid limegreen;
        }
        .widget-button:hover {
            background-color: darkgrey;
        }

        .company-list {
            position: absolute;
            bottom: calc(100% + 10px);
            right: 0;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
        }

        .select-all-button,
        .save-choices-button {
            margin-top: 10px;
            background-color: #007bff;
            color: #fff;
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            text-align: center;
            text-decoration: none;
            transition: background-color 0.3s ease;
            display: block;
            margin-bottom: 5px;
        }

        .select-all-button:hover,
        .save-choices-button:hover {
            background-color: #0056b3;
        }

        .widget-button:active {
            background-color: #004080;
        }
    </style>
</head>
<body>
<div class="widget-container">
    <button class="widget-button" onclick="toggleCompanyList()">Open Opt out companies</button>
    <!--<div class="company-list" style="display: none;"> &lt;!&ndash; Initially hidden &ndash;&gt;
        <label><input type="checkbox" value="company1"> Company 1</label><br>
        <label><input type="checkbox" value="company2"> Company 2</label><br>
        <label><input type="checkbox" value="company3"> Company 3</label><br>
        <button class="select-all-button" onclick="toggleSelectAll()">Select all</button>
        <button class="save-choices-button" onclick="saveChoices()">Save choices</button>
        <br/>
        &lt;!&ndash;    Duplicate request from excel with action_id=4&ndash;&gt;
        <button class="widget-button" onclick="duplicateOptOutRequestFromAboutAds()">Opt out companies with action_id=4</button>
        &lt;!&ndash;    We need to send a request with action_id=3 in order to get the CSRF token that should be used in the request with action_id=4&ndash;&gt;
        <button class="widget-button" onclick="optOutDemDexNgrok()">Opt out dem dex using action_id=3 and action_id=4</button>
        <hr/>
    </div>-->
    <div class="company-list">
        <h2><b>chain with iframe src:</b></h2>
        <div id="iframe-src-button-container"></div>
        <hr/>
        <h2><b>chain with multiple fetches:</b></h2>
        <div id="multiple-fetches-button-container"></div>
    </div>
</div>

<script>
  const successInOptOutAboutAds = "Request is success";
  const status = {
    fail: 'fail',
    success: 'success',
    successWhenNoAdBlocker: 'successWhenNoAdBlocker',
  }
  const companiesToOptOut = [
    {participantId: 512, name: 'Adobe Marketing Cloud - Advertising Services', url: 'https://www.demdex.net/daa/daa_opt.html', status: status.success, hint: successInOptOutAboutAds, exactUrls: ['no-url, request went right to action_id=4', 'https://optout.aboutads.info/finish/512/4/1/']},
    {participantId: 789, name: 'IQM', url: 'https://pxl.iqm.com/api/v1/twb/opt_out', status: status.success, hint: successInOptOutAboutAds, exactUrls: ['https://optout.aboutads.info/token/789/1/29c20b7f96c7d51421db9667dc879d78', 'https://optout.aboutads.info/finish/789/4/1']},
    {participantId: 756, name: 'OutBrain', url: 'https://nai.outbrain.com', status: status.success, hint: successInOptOutAboutAds, exactUrls: ['https://optout.aboutads.info/token/756/1-1/4e88341cb0b64fae985401c4e618c638', 'https://optout.aboutads.info/finish/756/4/1-1/']},
    {participantId: 787, name: 'The Trade Desk', url: 'https://insight.adsrvr.org/track/optout', status: status.successWhenNoAdBlocker, hint: successInOptOutAboutAds, exactUrls: ['https://optout.aboutads.info/token/787/3-3/062424142252', 'https://optout.aboutads.info/finish/787/4/1-1/User Opted Out']},

    {participantId: 258, name: '33Across', url: 'https://optout.33across.com/api/', status: status.successWhenNoAdBlocker, hint: successInOptOutAboutAds, exactUrls: ['https://optout.aboutads.info/token/258/1/b8b4bedfd79e9ada/', 'https://optout.aboutads.info/finish/258/4/1/']},
    {participantId: 488, name: '33Across (alternative)', url: 'https://optout.tynt.com/api/', status: status.successWhenNoAdBlocker, hint: successInOptOutAboutAds, exactUrls: ['https://optout.aboutads.info/token/488/1/b8b4bedfd79e9ada/', 'https://optout.aboutads.info/finish/488/4/1/']},
    {participantId: 383, name: 'AcuityAds', url: 'https://acuityplatform.com/Adserver/nai', status: status.successWhenNoAdBlocker, hint: successInOptOutAboutAds, exactUrls: ['https://optout.aboutads.info/token/383/1/de9FDqymUa/', 'https://optout.aboutads.info/finish/383/4/1/']},
    {participantId: 788, name: 'Adbrain', url: 'https://insight.adsrvr.org/track/optout', status: status.successWhenNoAdBlocker, hint: successInOptOutAboutAds, exactUrls: ['https://optout.aboutads.info/token/788/1-2/062424134419/', 'https://optout.aboutads.info/finish/788/4/1-1/User Opted Out/']},
    {participantId: 642, name: 'Adelphic', url: 'https://my.ipredictive.com/optout/aboutads', status: status.successWhenNoAdBlocker, hint: successInOptOutAboutAds, exactUrls: ['https://optout.aboutads.info/token/642/1/adelphic', 'https://optout.aboutads.info/finish/642/4/1/adelphic']},
    {participantId: 858, name: 'Adform', url: 'https://track.adform.net/opt/nai', status: status.successWhenNoAdBlocker, hint: successInOptOutAboutAds, exactUrls: ['https://optout.aboutads.info/token/858/1-1/_GawbSkyWMQDvP-67D9Y4w', 'https://optout.aboutads.info/finish/858/4/1-0']},
    {participantId: 647, name: 'AdGear Technologies', url: 'https://rtb.adgrx.com/coop/optout', status: status.successWhenNoAdBlocker, hint: successInOptOutAboutAds, exactUrls: ['https://optout.aboutads.info/token/647/1/878307127/', 'https://optout.aboutads.info/finish/647/4/1/']},
    {participantId: 569, name: 'Adstra', url: 'https://preferences.bluecava.com/daa/optout.ashx', status: status.success, hint: successInOptOutAboutAds, exactUrls: ['https://optout.aboutads.info/token/569/1/bluecava-csrf/', 'https://optout.aboutads.info/finish/569/4/1/']},
    {participantId: 768, name: 'Alphonso', url: 'https://optout.alphonso.tv/optout_v1', status: status.fail, hint: 'Bad request 400 to Location https://match.prod.bidr.io/cookie-sync/alphonso?_bee_ppp=1'},
    {participantId: 801, name: 'Amazon Ad System', url: 'https://s.amazon-adsystem.com/coop', status: status.successWhenNoAdBlocker, hint: successInOptOutAboutAds, exactUrls: ['https://optout.aboutads.info/token/801/1/1435f06c3f120d2a930194f8088fe345', 'https://optout.aboutads.info/finish/801/4/1/ok']},
    {participantId: 636, name: 'Amobee', url: 'https://ad.amgdgt.com/ads/nai-coop-opt-out', status: status.successWhenNoAdBlocker, hint: successInOptOutAboutAds, exactUrls: ['https://ad.amgdgt.com/ads/master-opt-out?src=NAI&action_id=3&participant_id=636&rd=https://optout.aboutads.info&noCache=1719238321678', 'https://optout.aboutads.info/finish/636/4/1/success/']},
    {participantId: 713, name: 'Amobee (alternative)', url: 'https://r.turn.com/r/optout', status: status.success, hint: successInOptOutAboutAds, exactUrls: ['https://optout.aboutads.info/token/713/1-3/', 'https://optout.aboutads.info/finish/713/4/1-1/']},
    {participantId: 823, name: 'Audiencerate', url: 'https://optout.audrte.com/nai', status: status.success, hint: successInOptOutAboutAds, exactUrls: ['https://optout.aboutads.info/token/823/1-0', 'https://optout.aboutads.info/finish/823/4/1-0']},
    {participantId: 811, name: 'AuDigent', url: 'https://ids.ad.gt/api/v1/optout/nai', status: status.successWhenNoAdBlocker, hint: successInOptOutAboutAds, exactUrls: ['https://optout.aboutads.info/token/811/1-0', 'https://optout.aboutads.info/token/811/1-0']},
    {participantId: 879, name: 'Basis', url: 'https://pixel-optout.sitescout.com/daaWebChoices', status: status.successWhenNoAdBlocker, hint: successInOptOutAboutAds, exactUrls: ['no-url, request went right to action_id=4', 'https://optout.aboutads.info/finish/879/4/1']},
    {participantId: 781, name: 'Beeswax', url: 'https://optout.prod.bidr.io/optout', status: status.successWhenNoAdBlocker, hint: successInOptOutAboutAds, exactUrls: ['https://optout.aboutads.info/token/781/2/0b9490d1f38e', 'https://optout.aboutads.info/finish/781/4/1']},
    {participantId: 718, name: 'Bombora', url: 'https://ml314.com/daaoptout.ashx', status: status.successWhenNoAdBlocker, hint: successInOptOutAboutAds, exactUrls: ['https://optout.aboutads.info/token/718/1/dG9rZW4tYm9tYm9yYQ==/', 'https://optout.aboutads.info/finish/718/4/1/']},
    {participantId: 816, name: 'Branch', url: 'https://app.link/nai-optout', status: status.success, hint: successInOptOutAboutAds, exactUrls: ['https://optout.aboutads.info/token/816/1-0', 'https://optout.aboutads.info/finish/816/4/1-0/optedOut']},
    {participantId: 809, name: 'Cadent', url: 'https://choices.adhaven.com/choices/daa/optout', status: status.successWhenNoAdBlocker, hint: successInOptOutAboutAds, exactUrls: ['https://optout.aboutads.info/token/809/1-2/', 'https://optout.aboutads.info/finish/809/4/1-1/']},
  ];

  // Create companies with opting out in iframe src
  const iframeSrcButtonContainer = document.getElementById('iframe-src-button-container');
  companiesToOptOut.forEach(company => {
    const button = document.createElement('button');
    button.className = `widget-button lightgrey ${company.status}`;
    button.innerText = company.name;
    button.onclick = () => invokeOptOutCompany(company, createIframeChainsWithNavigation);
    if (company.hint) {
      button.title = `Status on https://optout.aboutads.info/: ${company.hint}`;
    }
    iframeSrcButtonContainer.appendChild(button);
  });

  // Create companies with opting out when multiple fetches
  const multipleFetchesButtonContainer = document.getElementById('multiple-fetches-button-container');
  companiesToOptOut.slice(0, 5).forEach(company => {
    const button = document.createElement('button');
    button.className = `widget-button lightgray ${company.status}`;
    button.innerText = company.name;
    button.onclick = () => invokeOptOutCompany(company, createChainWithFetches);
    if (company.hint) {
      button.title = `Status on https://optout.aboutads.info/: ${company.hint}`;
    }
    multipleFetchesButtonContainer.appendChild(button);
  });

  function toggleCompanyList() {
    const companyList = document.querySelector('.company-list');
    if (companyList.style.display === 'none') {
      companyList.style.display = 'block';
    } else {
      companyList.style.display = 'none';
    }
  }



  function getRandomizedValue() {
    // Generate a 13-digit random number
    return Math.floor(Math.random() * 9e12) + 1e12;
  }



  /* Common function */

  function invokeOptOutCompany(company, cb) {
    cb(company.participantId, company.url)
      .then((data) => {
        console.log(`Data response from ${company.name}:`, data);
        if (!company.hasOwnProperty('status')) {
          return;
        }

        if (company.status === status.success || company.status === status.successWhenNoAdBlocker) {
          console.log('Company was successful on https://optout.aboutads.info/ as well.');

          const responseUrlPath = new URL(data).pathname;
          const expectedUrlPath = new URL(company.exactUrls[company.exactUrls.length - 1]).pathname;
          if (expectedUrlPath === responseUrlPath) {
            console.log('Final url is the same.');
          } else {
            console.error(`Final url is the different. Current url is ${responseUrlPath}, expected url is ${expectedUrlPath}`);
          }
        } else {
          console.error('Company had an error on https://optout.aboutads.info/. Currently it`s successful');
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        if (company.status === status.success || company.status === status.successWhenNoAdBlocker) {
          console.error('Company was successful on https://optout.aboutads.info/. Currently it`s errored');
        } else {
          console.log('Company had an error on https://optout.aboutads.info/ as well.');
        }
      });
  }

  /* ChainWithMultipleFetches */

  function createChainWithFetches(participantId, url) {
    const firstUrl = `${url}?action_id=3&participant_id=${participantId}&rd=${encodeURIComponent(window.location.origin)}&noCache=${getRandomizedValue()}`;

    return fetch(firstUrl)
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok');
        }
        const redirectedURL = response.url;
        const urlParts = redirectedURL.split('/');
        const token = urlParts[urlParts.length - 1];

        const secondUrl = `${url}?action_id=4&participant_id=${participantId}&token=${token}&rd=${encodeURIComponent(window.location.origin)}&noCache=${getRandomizedValue()}`;

        return fetch(secondUrl)
          .then(response => {
            return response.url;
          });
      });
  }

  /* Chain with fetches in iframe navigate */

  function createIframeChainsWithNavigation(participantId, url) {
    return new Promise((resolve, reject) => {
      const firstUrl = `${url}?action_id=3&participant_id=${participantId}&rd=${encodeURIComponent(window.location.origin)}&noCache=${getRandomizedValue()}`;

      const firstIframe = document.createElement('iframe');
      firstIframe.src = firstUrl;
      firstIframe.style.display = 'none';
      document.body.appendChild(firstIframe);

      firstIframe.onload = () => {
        const redirectedURL = firstIframe.contentWindow.location.href;
        const urlParts = redirectedURL.split('/');
        const token = urlParts[urlParts.length - 1];
        const secondUrl = `${url}?action_id=4&participant_id=${participantId}&token=${token}&rd=${encodeURIComponent(window.location.origin)}&noCache=${getRandomizedValue()}`;

        const secondIframe = document.createElement('iframe');
        secondIframe.src = secondUrl;
        secondIframe.style.display = 'none'; // Hide the iframe
        document.body.appendChild(secondIframe);

        secondIframe.onload = () => {
          resolve(secondIframe.contentWindow.location.href);
        };

        secondIframe.onerror = (error) => {
          reject(error);
        };
      };

      firstIframe.onerror = (error) => {
        reject(error);
      };
    });
  }
</script>
</body>
</html>
